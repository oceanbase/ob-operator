"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[8736],{3123:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=t(4848),n=t(8453);t(1470),t(9365);const o={sidebar_position:2},s="Recover from node failure",i={id:"manual/ob-operator-user-guide/high-availability/disaster-recovery-of-ob-operator",title:"Recover from node failure",description:"This topic describes how to recover from the failures of OBServer nodes by using ob-operator.",source:"@site/docs/manual/500.ob-operator-user-guide/300.high-availability/300.disaster-recovery-of-ob-operator.md",sourceDirName:"manual/500.ob-operator-user-guide/300.high-availability",slug:"/manual/ob-operator-user-guide/high-availability/disaster-recovery-of-ob-operator",permalink:"/ob-operator/docs/manual/ob-operator-user-guide/high-availability/disaster-recovery-of-ob-operator",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/ob-operator/tree/master/docsite/docs/manual/500.ob-operator-user-guide/300.high-availability/300.disaster-recovery-of-ob-operator.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"manualSidebar",previous:{title:"High availability",permalink:"/ob-operator/docs/manual/ob-operator-user-guide/high-availability/high-availability-intro"},next:{title:"Back up a tenant",permalink:"/ob-operator/docs/manual/ob-operator-user-guide/high-availability/tenant-backup-of-ob-operator"}},l={},c=[{value:"Based on the multi-replica capability of OceanBase Database",id:"based-on-the-multi-replica-capability-of-oceanbase-database",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Recovery policy",id:"recovery-policy",level:3},{value:"Based on the Calico network plugin",id:"based-on-the-calico-network-plugin",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Restore policy",id:"restore-policy",level:3},{value:"Based on Kubernetes service",id:"based-on-kubernetes-service",level:2},{value:"Prerequisites",id:"prerequisites-2",level:3},{value:"Restore policy",id:"restore-policy-1",level:3},{value:"Verification",id:"verification",level:2},{value:"Deployment suggestions",id:"deployment-suggestions",level:2}];function u(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.h1,{id:"recover-from-node-failure",children:"Recover from node failure"}),"\n",(0,a.jsx)(r.p,{children:"This topic describes how to recover from the failures of OBServer nodes by using ob-operator."}),"\n",(0,a.jsx)(r.admonition,{type:"note",children:(0,a.jsx)(r.p,{children:"Before OceanBase 4.2.3.0, the database kernel cannot communicate using virtual IP addresses. When the Pod IP address changes, the observer cannot start normally. To restart the observer in place after it fails, you must fix the IP address of the node. Otherwise, you can only rely on the majority of nodes to add a new Pod to the cluster as a new node and synchronize data to restore the original number of nodes."})}),"\n",(0,a.jsx)(r.h2,{id:"based-on-the-multi-replica-capability-of-oceanbase-database",children:"Based on the multi-replica capability of OceanBase Database"}),"\n",(0,a.jsx)(r.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"To successfully recover the OceanBase cluster, you must deploy at least three nodes and a tenant with at least three replicas."}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"This method can only handle the failure of a minority of nodes"}),", such as the failure of one node in a three-node cluster."]}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"recovery-policy",children:"Recovery policy"}),"\n",(0,a.jsx)(r.p,{children:"When an OBServer node fails, ob-operator detects the pod exception and creates a new OBServer node to join the cluster. The new OBServer node synchronizes data with the original node until all data is synchronized."}),"\n",(0,a.jsx)(r.p,{children:"During the recovery process, if a majority of OBServer nodes fail, the cluster cannot be restored. In this case, you must manually restore the cluster by using the backup and restore feature of ob-operator."}),"\n",(0,a.jsx)(r.h2,{id:"based-on-the-calico-network-plugin",children:"Based on the Calico network plugin"}),"\n",(0,a.jsx)(r.h3,{id:"prerequisites-1",children:"Prerequisites"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["To use the static IP address feature, you must install ",(0,a.jsx)(r.a,{href:"https://docs.tigera.io/calico/latest/getting-started/kubernetes/",children:"Calico"})," as the network plugin for the Kubernetes cluster."]}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"restore-policy",children:"Restore policy"}),"\n",(0,a.jsx)(r.p,{children:"When a minority of OBServer nodes fail, the multi-replica mechanism of OceanBase Database ensures the availability of the cluster, and ob-operator detects a pod exception. Then, ob-operator creates an OBServer node, adds it to the cluster, and deletes the abnormal OBServer node. OceanBase Database replicates the data of replicas on the abnormal OBServer node to the new node."}),"\n",(0,a.jsx)(r.p,{children:"If you have installed Calico for the Kubernetes cluster, this process can be easier. ob-operator can start a new observer process by using the IP address of the abnormal OBServer node. This way, the data on the abnormal OBServer node, if the data still exists, can be directly used without the replication step. Moreover, if a majority of OBServer nodes fail, this method can also restore the service after all new OBServer nodes are started."}),"\n",(0,a.jsx)(r.h2,{id:"based-on-kubernetes-service",children:"Based on Kubernetes service"}),"\n",(0,a.jsx)(r.h3,{id:"prerequisites-2",children:"Prerequisites"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"Only OceanBase Database of version >= 4.2.3.0 support this feature."}),"\n",(0,a.jsxs)(r.li,{children:["Create an OBCluster in ",(0,a.jsx)(r.code,{children:"service"})," mode. The configuration is as follows:"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",children:"apiVersion: oceanbase.oceanbase.com/v1alpha1\nkind: OBCluster\nmetadata:\n  name: test\n  namespace: oceanbase\n  annotations:\n    oceanbase.oceanbase.com/mode: service # This is the key configuration\nspec:\n# ...\n"})}),"\n",(0,a.jsx)(r.h3,{id:"restore-policy-1",children:"Restore policy"}),"\n",(0,a.jsxs)(r.p,{children:["After creating an OBCluster in ",(0,a.jsx)(r.code,{children:"service"})," mode, ob-operator will attach a ",(0,a.jsx)(r.code,{children:"service"})," to each OBServer pod and take the ClusterIP of the service as the networking IP."]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"When an OBServer pod restarts, the observer can restart in place by using the constant ClusterIP of the service for communication."}),"\n",(0,a.jsx)(r.li,{children:"When an OBServer pod is mistakenly deleted, ob-operator will create a new OBServer pod and use the same ClusterIP for communication. The new node will automatically join the OceanBase cluster and resume service."}),"\n"]}),"\n",(0,a.jsx)(r.h2,{id:"verification",children:"Verification"}),"\n",(0,a.jsx)(r.p,{children:"You can verify the restore result of ob-operator by performing the following steps."}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"Delete the pod:"}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl delete pod obcluster-1-zone1-074bda77c272 -n oceanbase\n"})}),"\n",(0,a.jsxs)(r.ol,{start:"2",children:["\n",(0,a.jsx)(r.li,{children:"View the restore result. The output shows that the pod of zone1 has been created and is ready."}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl get pods -n oceanbase\n\nNAME                                  READY   STATUS    RESTARTS   AGE\nobcluster-1-zone3-074bda77c272        2/2     Running   0          12d\nobcluster-1-zone2-7ecbd89f84de        2/2     Running   0          12d\nobcluster-1-zone1-94ecf05cb290        2/2     Running   0          1m\n"})}),"\n",(0,a.jsx)(r.h2,{id:"deployment-suggestions",children:"Deployment suggestions"}),"\n",(0,a.jsxs)(r.p,{children:["To deploy a production cluster with high availability, we recommend that you deploy an OceanBase cluster of at least three OBServer nodes, create tenants that each has at least three replicas, distribute nodes of each zone on different servers, and use the network plug-in Calico (or set OBCluster as ",(0,a.jsx)(r.code,{children:"service"})," mode in ob-operator 2.2.0 and later versions). This minimizes the risk of an unrecoverable cluster disaster. ob-operator also provides high-availability solutions based on the backup and restore of tenant data and the primary and standby tenants. For more information, see ",(0,a.jsx)(r.a,{href:"/ob-operator/docs/manual/ob-operator-user-guide/high-availability/data-recovery-of-ob-operator",children:"Restore data from a backup"})," and ",(0,a.jsx)(r.a,{href:"/ob-operator/docs/manual/ob-operator-user-guide/high-availability/tenant-backup-of-ob-operator",children:"Back up a tenant"}),"."]})]})}function d(e={}){const{wrapper:r}={...(0,n.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},9365:(e,r,t)=>{t.d(r,{A:()=>s});t(6540);var a=t(4164);const n={tabItem:"tabItem_Ymn6"};var o=t(4848);function s(e){let{children:r,hidden:t,className:s}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,a.A)(n.tabItem,s),hidden:t,children:r})}},1470:(e,r,t)=>{t.d(r,{A:()=>w});var a=t(6540),n=t(4164),o=t(3104),s=t(6347),i=t(205),l=t(7485),c=t(1682),u=t(9466);function d(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:r}=e;return!!r&&"object"==typeof r&&"value"in r}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:r,children:t}=e;return(0,a.useMemo)((()=>{const e=r??function(e){return d(e).map((e=>{let{props:{value:r,label:t,attributes:a,default:n}}=e;return{value:r,label:t,attributes:a,default:n}}))}(t);return function(e){const r=(0,c.X)(e,((e,r)=>e.value===r.value));if(r.length>0)throw new Error(`Docusaurus error: Duplicate values "${r.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[r,t])}function p(e){let{value:r,tabValues:t}=e;return t.some((e=>e.value===r))}function b(e){let{queryString:r=!1,groupId:t}=e;const n=(0,s.W6)(),o=function(e){let{queryString:r=!1,groupId:t}=e;if("string"==typeof r)return r;if(!1===r)return null;if(!0===r&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:r,groupId:t});return[(0,l.aZ)(o),(0,a.useCallback)((e=>{if(!o)return;const r=new URLSearchParams(n.location.search);r.set(o,e),n.replace({...n.location,search:r.toString()})}),[o,n])]}function f(e){const{defaultValue:r,queryString:t=!1,groupId:n}=e,o=h(e),[s,l]=(0,a.useState)((()=>function(e){let{defaultValue:r,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(r){if(!p({value:r,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${r}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return r}const a=t.find((e=>e.default))??t[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:r,tabValues:o}))),[c,d]=b({queryString:t,groupId:n}),[f,v]=function(e){let{groupId:r}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(r),[n,o]=(0,u.Dv)(t);return[n,(0,a.useCallback)((e=>{t&&o.set(e)}),[t,o])]}({groupId:n}),m=(()=>{const e=c??f;return p({value:e,tabValues:o})?e:null})();(0,i.A)((()=>{m&&l(m)}),[m]);return{selectedValue:s,selectValue:(0,a.useCallback)((e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),v(e)}),[d,v,o]),tabValues:o}}var v=t(2303);const m={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var y=t(4848);function g(e){let{className:r,block:t,selectedValue:a,selectValue:s,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,o.a_)(),u=e=>{const r=e.currentTarget,t=l.indexOf(r),n=i[t].value;n!==a&&(c(r),s(n))},d=e=>{let r=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;r=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;r=l[t]??l[l.length-1];break}}r?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,n.A)("tabs",{"tabs--block":t},r),children:i.map((e=>{let{value:r,label:t,attributes:o}=e;return(0,y.jsx)("li",{role:"tab",tabIndex:a===r?0:-1,"aria-selected":a===r,ref:e=>l.push(e),onKeyDown:d,onClick:u,...o,className:(0,n.A)("tabs__item",m.tabItem,o?.className,{"tabs__item--active":a===r}),children:t??r},r)}))})}function x(e){let{lazy:r,children:t,selectedValue:n}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(r){const e=o.find((e=>e.props.value===n));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:o.map(((e,r)=>(0,a.cloneElement)(e,{key:r,hidden:e.props.value!==n})))})}function j(e){const r=f(e);return(0,y.jsxs)("div",{className:(0,n.A)("tabs-container",m.tabList),children:[(0,y.jsx)(g,{...e,...r}),(0,y.jsx)(x,{...e,...r})]})}function w(e){const r=(0,v.A)();return(0,y.jsx)(j,{...e,children:d(e.children)},String(r))}},8453:(e,r,t)=>{t.d(r,{R:()=>s,x:()=>i});var a=t(6540);const n={},o=a.createContext(n);function s(e){const r=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),a.createElement(o.Provider,{value:r},e.children)}}}]);